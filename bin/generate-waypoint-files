#!/usr/bin/python

import os, sys, re
import shutil

app_dir = os.path.abspath(__file__ + '/../..')
sys.path.append(os.path.join(app_dir, 'lib'))

from xcsoar.mapgen.waypoints.list import WaypointList
from xcsoar.mapgen.waypoints import welt2000
from xcsoar.mapgen.waypoints.seeyou_writer import write_seeyou_waypoints
from xcsoar.mapgen.downloader import Downloader
from xcsoar.mapgen.country_codes import get_country_name

def main():
    dir_data = os.path.join(app_dir, 'data')
    
    print("Reading Welt2000 waypoint file ...")
    waypoints = welt2000.get_database(dir_data)
    
    print("Building database ...")
    database = {}
    for waypoint in waypoints:
        country = get_country_name(waypoint.country_code)
        if not country:
            print("Country code not found: " + waypoint.country_code)
            continue
        
    	if country not in database:
            database[country] = WaypointList() 
    
        database[country].append(waypoint)
    
    for country, waypoints in database.iteritems():
        path = country + ".cup"
        print("Writing " + country + ".cup (" + str(len(waypoints)) + " entries) ...")
        write_seeyou_waypoints(waypoints, path)

if __name__ == '__main__':
    main()
